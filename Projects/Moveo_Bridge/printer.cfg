# ============================================================================
# üö® SAFETY REQUIREMENTS:
# ============================================================================
# 
# 1. JOINT 2 SYNCHRONIZATION: Motors joint2 (Motor-8) and joint2b (Motor-7)
#    are mechanically coupled. NEVER move independently!
#    ‚úÖ Use: JOINT2_PLUS, JOINT2_MINUS, JOINT2_MOVE macros
#    ‚úÖ Manual: MANUAL_STEPPER with SYNC parameters
#    ‚ùå NEVER: Individual motor commands without coordination
#
# 2. Commands
    #MANUAL_STEPPER STEPPER=joint1 MOVE=0 SPEED=30 SYNC=0
    #MANUAL_STEPPER STEPPER=joint3 MOVE=0 SPEED=0 SYNC=0
    #MANUAL_STEPPER STEPPER=joint4 MOVE=0 SPEED=60 SYNC=0
    #MANUAL_STEPPER STEPPER=joint5 MOVE=0 SPEED=60 SYNC=0
    #MANUAL_STEPPER STEPPER=joint2 MOVE=-20 SPEED=30 SYNC=0
    #MANUAL_STEPPER STEPPER=joint2b MOVE=-20 SPEED=30 SYNC=1


    #MANUAL_STEPPER STEPPER=joint1 SET_POSITION=0 SYNC=0
    #MANUAL_STEPPER STEPPER=joint3 SET_POSITION=0 SYNC=0
    #MANUAL_STEPPER STEPPER=joint4 SET_POSITION=0 SYNC=0
    #MANUAL_STEPPER STEPPER=joint5 SET_POSITION=0 SYNC=0
    #MANUAL_STEPPER STEPPER=joint6 SET_POSITION=0 SYNC=0
    #MANUAL_STEPPER STEPPER=joint7 SET_POSITION=300 SYNC=0
    #MANUAL_STEPPER STEPPER=joint2 SET_POSITION=0 SYNC=0
    #MANUAL_STEPPER STEPPER=joint2b SET_POSITION=0 SYNC=1









#
# ============================================================================
# üìã CONFIGURATION REFERENCE FOR OTHER SYSTEMS:
# ============================================================================
#
# ROS Integration:    Reference position_min/max for joint_limits.yaml
# MoveIt Planning:    Use these ranges for planning scene setup
# API Interfaces:     Enforce these limits in trajectory validation
# Documentation:      Always cite this file as authoritative source
# Testing Scripts:    Respect these limits in automated movement tests
#
# Last Updated: $(date '+%Y-%m-%d %H:%M:%S') - Joint range documentation added
# Hardware: BTT Octopus Max EZ + TMC5160 drivers
# Firmware: Klipper (manual_stepper configuration)
#
# ============================================================================

# RESPOND command support
[respond]
default_type: echo

# This file contains common pin mappings for the BIGTREETECH Octopus Max EZ.
# To use this config, the firmware should be compiled for the STM32H723 with a "128KiB bootloader" and "25 MHz crystal",
# and one of:
# Communication interface: "USB (on PA11/PA12)",
# Communication interface: "CAN bus (on PD0/PD1)", or
# Communication interface: "USB to CAN bus bridge (USB on PA11/PA12))" and CAN bus interface: "CAN bus (on PD0/PD1)".
# See docs/Config_Reference.md for a description of parameters.

# BCN3D Moveo 6-DOF Robotic Arm Configuration
# Inverted joint order as requested

# Motor-1 Slot - Linear Traverse (Joint 7) - ENABLED
# Mechanics: 23HS30-2804A, 25:1 gearbox (NMRV30), Mod 3 rack, 16T pinion, herringbone; microstep = 1
[manual_stepper joint7]
step_pin: PC13
dir_pin: PC14
enable_pin: !PE6
microsteps: 1
full_steps_per_rotation: 200
# rotation_distance = pi * module * teeth / gear_ratio = pi*3*16/25 ‚âà 6.03186 mm per motor rev
rotation_distance: 6.03186
# Initial safe motion limits (mm, mm/s); refine after bring-up
velocity: 5
accel: 50
# No endstops for now

# TMC5160 Driver for Joint7 (Motor-1 slot)
[tmc5160 manual_stepper joint7]
cs_pin: PG14 
spi_bus: spi4
run_current: 2.6            # conservative start for 2.8A rated motor
hold_current: 2.0
sense_resistor: 0.075
stealthchop_threshold: 999999   # per request
interpolate: True

# Motor-6 - Tool Head (Joint 6) - ENABLED
[manual_stepper joint6]
step_pin: PG15
dir_pin: PB3
enable_pin: !PD5
microsteps: 1
full_steps_per_rotation: 200
rotation_distance: 360
gear_ratio: 19:1
velocity: 500
accel: 500
endstop_pin: ^!PC15  # M6-DET (motor6 endstop)
#position_min: -90
#position_max: 90

# TMC5160 Driver for Joint6 (Motor-6)
[tmc5160 manual_stepper joint6]
cs_pin: PG9                 # Motor-6 CS/UART on Octopus Max EZ
spi_bus: spi4
run_current: 0.42            # 70% of 0.6A max
hold_current: 0.30           # 50% of 0.6A max
sense_resistor: 0.075
stealthchop_threshold: 999999
interpolate: True

# Motor-5 - Wrist Roll (Joint 5) - ENABLED
[manual_stepper joint5]
step_pin: PB5
dir_pin: PB4
enable_pin: !PB6
microsteps: 1
full_steps_per_rotation: 200
rotation_distance: 360
gear_ratio: 45:10
velocity: 500
accel: 500
endstop_pin: ^!PF1  # M5-DET (motor5 endstop)
position_min: -90
position_max: 115

# TMC5160 Driver for Joint5 (Motor-5)
[tmc5160 manual_stepper joint5]
cs_pin: PG10                # Motor-5 CS/UART on Octopus Max EZ
spi_bus: spi4
run_current: 0.35            # 70% of 0.5A max
hold_current: 0.25           # 50% of 0.5A max
sense_resistor: 0.075
stealthchop_threshold: 999999
interpolate: True

# Motor-4 - Wrist Pitch (Joint 4) - ENABLED
[manual_stepper joint4]
step_pin: PB8
dir_pin: PB9
enable_pin: !PB7
microsteps: 1
full_steps_per_rotation: 200
rotation_distance: 345.6
gear_ratio: 5:1
velocity: 500
accel: 500
endstop_pin: ^!PF3  # M4-DET (motor4 endstop)
#position_min: -200
#position_max: 200

# TMC5160 Driver for Joint4 (Motor-4)
[tmc5160 manual_stepper joint4]
cs_pin: PG11                # Motor-4 CS/UART on Octopus Max EZ
spi_bus: spi4
run_current: 0.28            # 70% of 0.4A max
hold_current: 0.2           # 50% of 0.4A max
sense_resistor: 0.075
stealthchop_threshold: 999999
interpolate: True

# Motor-3 - Elbow (Joint 3) - ENABLED  (SPEED=30)
[manual_stepper joint3]
step_pin: PE1
dir_pin: !PE0
enable_pin: !PE2
microsteps: 1
full_steps_per_rotation: 200
rotation_distance: 360          # Use degree units for consistency
gear_ratio: 61:1               # 14:1 gear + T5 Gear(61:14): 28 motor revs = 1 joint rev (17HS19-1684S-PG14)
endstop_pin: ^!PF4             # Endstop3 (mapped to PF3) ‚Äî adjust if your wiring uses a different port
position_endstop: 115           # Assume positive endstop; adjust after calibration
position_min: -90              # Soft limits (assumed initial range)
position_max: 115
velocity: 500
accel: 500
homing_speed: 10
second_homing_speed: 3
homing_retract_dist: 5

# TMC5160 Driver for Joint3 (Motor-3)
# Model: 17HS19-1684S-PG14 (max 1.68A)
[tmc5160 manual_stepper joint3]
cs_pin: PG12                 # Candidate CS pin for Motor-6 (adjusted)
spi_bus: spi4
run_current: 1.176          # 70% of 1.68A
hold_current: 0.84          # 50% of 1.68A
sense_resistor: 0.075
stealthchop_threshold: 999999
interpolate: True

# =================================================================
# JOINT 2 SHOULDER - DUAL MOTOR CONFIGURATION
# =================================================================
# ‚ö†Ô∏è  CRITICAL SAFETY REQUIREMENT:
# Joint2 uses TWO mechanically linked motors that MUST move in sync
# - joint2  (Motor-8): Primary motor with endstop
# - joint2b (Motor-7): Secondary motor with inverted direction
# 
# ‚ùå NEVER move these motors independently
# ‚úÖ ALWAYS use coordinated movement commands (SYNC parameters)
# ‚úÖ Use JOINT2_MOVE, JOINT2_PLUS, JOINT2_MINUS macros
# =================================================================

# Motor-7 - Joint 2B (Secondary motor)
# Direction inverted for coordinated dual-motor movement

# TMC5160 Driver for Joint2b (Motor-7)- CORRECTED CONFIGURATION
[tmc5160 manual_stepper joint2b]
cs_pin: PD7
spi_bus: spi4
run_current: 2.8                # 70% of 4.0A motor rating for safe operation
hold_current: 2.0               # 50% of motor rating for holding torque
sense_resistor: 0.075
stealthchop_threshold: 999999   # Enable StealthChop for quiet operation
interpolate: True

[manual_stepper joint2b]
# CRITICAL: joint2 and joint2b MUST move in sync at all times
# These motors are mechanically linked - never move independently
step_pin: PD3
dir_pin: PD2  # Flipped direction to match joint2
enable_pin: !PD4
# NO endstop_pin - joint2b follows joint2 for homing
microsteps: 1
full_steps_per_rotation: 200
rotation_distance: 360          # One motor rev = 360 "deg units"
gear_ratio: 77:14               # Motor:joint ratio (Joint 2 calibrated ratio)
position_min: -90               # Lower soft limit (matches joint2)
position_max: 115.5               # Upper soft limit (matches joint2)
velocity: 500
accel: 500
# Note: No homing parameters - joint2b follows joint2 for homing

# Motor-8 - Joint 2 Main (Dual-motor setup with Motor-7)
# Works with joint2b for coordinated shoulder movement

# TMC5160 Driver for Joint2 (Motor-8) - CORRECTED CONFIGURATION
[tmc5160 manual_stepper joint2]
cs_pin: PD6
spi_bus: spi4
run_current: 2.8                # 70% of 4.0A motor rating for safe operation
hold_current: 2.0               # 50% of motor rating for holding torque
sense_resistor: 0.075
stealthchop_threshold: 999999   # Enable StealthChop for quiet operation
interpolate: True

[manual_stepper joint2]
# DUAL-MOTOR SHOULDER JOINT - Primary motor (Motor-8)
# ALWAYS coordinate with joint2b - never move independently
step_pin: PA10
dir_pin: !PA9
enable_pin: !PA15
endstop_pin: ^!PF2
microsteps: 1
full_steps_per_rotation: 200
rotation_distance: 360          # One motor rev = 360 "deg units"
gear_ratio: 77:14               # Motor:joint ratio (Joint 2 calibrated ratio)
position_endstop: 115.3        # Upper limit endstop trigger (now positive)
position_min: -90               # Lower soft limit
position_max: 115.5               # Upper soft limit
velocity: 500
accel: 500
homing_speed: 10                # deg/s first pass
second_homing_speed: 3          # deg/s precise approach  
homing_retract_dist: 5          # deg backoff distance

# Motor-1 / Base Rotation (Joint 1) - Back to manual_stepper
[tmc5160 manual_stepper joint1]
cs_pin: PG13
spi_bus: spi4
run_current: 0.5                # 80% of 0.63A motor rating for safe operation
hold_current: 0.38               # 60% of motor rating for holding torque   
sense_resistor: 0.075
stealthchop_threshold: 999999
interpolate: True

[manual_stepper joint1]
step_pin: PE4
dir_pin: PE5
enable_pin: !PE3
microsteps: 1
full_steps_per_rotation: 200
rotation_distance: 360          # One motor rev = 360 "deg units"
gear_ratio: 100:10               # Updated calibration: motor:joint (10 motor revs = 1 joint rev)
endstop_pin: ^!PF0              # Assuming NO switch, trigger on logic high (maintains prior invert)
position_endstop: 82             # Physical trigger angle
position_min: -82               # Full range negative soft limit
position_max: 82                # Positive soft limit
velocity: 500
accel: 500
homing_speed: 10                # deg/s first pass
second_homing_speed: 3          # deg/s precise approach  
homing_retract_dist: 5          # deg backoff distance

# Simple fan for cooling electronics
[fan]
pin: PA6

# 3-wire fan tachometer input - PC3 pin 29
# Using filament sensor to detect tachometer pulses (standard method)
[filament_switch_sensor fan4_tach]
switch_pin: ^PC3  # Pin 29 - Fan4 tachometer with pullup resistor
pause_on_runout: False
runout_gcode:
insert_gcode:

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_1B0026000651323235363233-if00

[printer]
kinematics: none
max_velocity: 500
max_accel: 500

[board_pins]
aliases:
    # FPC header, Aliases EXP1 & EXP2 for mini12864
    EXP1_1=PG2, EXP1_2=PD15,
    EXP1_3=PD14, EXP1_4=PD13,
    EXP1_5=PD12, EXP1_6=PD11,
    EXP1_7=PD10, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PE13, EXP2_2=PE12,
    EXP2_3=PG5, EXP2_4=PE11,
    EXP2_5=PG4, EXP2_6=PE14,
    EXP2_7=PG3, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<NC>

# Virtual SD Card Support
[virtual_sdcard]
path: ~/printer_data/gcodes

# Pause/Resume Support
[pause_resume]

# Display Status Support (for Mainsail/Fluidd)
[display_status]

# Enable object cancellation
[exclude_object]

# Mainsail klipper definitions
[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
gcode:
  PAUSE_BASE
  
[gcode_macro HOME_JOINT_BASE]
description: Home Joint Base (joint1) using endstop - Reliable homing
gcode:
    {% set speed = params.SPEED|default(5)|float %}
    {% set backoff = params.BACKOFF|default(5)|float %}
    {% set backoff_speed = params.BACKOFF_SPEED|default(3)|float %}
    {% set approach = params.APPROACH|default(120)|float %}  # nominal large approach distance
  {% set max_pos = 81.5 %}  # Updated to match endstop + safety margin
    {% set margin = 0.5 %}  # safety margin below soft max
    {% set cur = printer['manual_stepper joint1'].position|float %}
    {% set dist_to_max = (max_pos - cur) %}
    {% if dist_to_max < -0.01 %}
      RESPOND MSG="‚ö† Current position {cur|round(2)} beyond max {max_pos}. Adjusting inside range."
      MANUAL_STEPPER STEPPER=joint1 SET_POSITION={max_pos - backoff - 1}
      {% set cur = printer['manual_stepper joint1'].position|float %}
      {% set dist_to_max = (max_pos - cur) %}
    {% endif %}
    {% if dist_to_max <= margin %}
      {% set perform_approach = False %}
    {% else %}
      {% set move_cmd = approach if approach < (dist_to_max - margin) else (dist_to_max - margin) %}
      {% set perform_approach = (move_cmd > 0.1) %}
    {% endif %}

    RESPOND MSG="üè† === HOMING JOINT BASE ==="
    RESPOND MSG="Pos={cur|round(2)} -> Max={max_pos} | DistToMax={dist_to_max|round(2)} | PlannedApproach={(perform_approach and move_cmd or 0)|round(2)}"
    RESPOND MSG="Speeds: Approach {speed}deg/s | Backoff {backoff}deg @ {backoff_speed}deg/s"
    MANUAL_STEPPER STEPPER=joint1 ENABLE=1

    {% if perform_approach %}
      RESPOND MSG="Approaching endstop (STOP_ON_ENDSTOP=1)..."
      MANUAL_STEPPER STEPPER=joint1 MOVE={move_cmd|round(3)} SPEED={speed} STOP_ON_ENDSTOP=1
    {% else %}
      RESPOND MSG="Already at or near endstop ‚Äî skipping approach move."
    {% endif %}

    RESPOND MSG="Backing off {backoff}deg at {backoff_speed}deg/s..."
    MANUAL_STEPPER STEPPER=joint1 MOVE=-{backoff} SPEED={backoff_speed}
    MANUAL_STEPPER STEPPER=joint1 SET_POSITION=0
    RESPOND MSG="‚úÖ Homing complete: Logical zero set {backoff}deg away from physical endstop."
    RESPOND MSG="(Run again with smaller BACKOFF for finer zero if desired)"

  {% for i in range(cycles) %}
    # Endstop state is checked directly by MANUAL_STEPPER STOP_ON_ENDSTOP functionality
    RESPOND MSG="Cycle {i+1}: Joint1 Endstop {'üî¥ TRIGGERED' if endstop_state else 'üü¢ NORMAL'} | Time: {printer.system_stats.cputime}"
    G4 P1000
  {% endfor %}
  
  RESPOND MSG="‚úÖ Monitoring complete"


# === Automatic Fan Startup (Option 1 Always-On) ===
# Brings FAN0 (default [fan]) to ~65% (M106 S166) shortly after Klipper starts.
# Adjust S value (0-255) or replace with SET_FAN_SPEED if converting to fan_generic.
[delayed_gcode FAN_BOOT]
initial_duration: 2
gcode:
  # Kick to full briefly to ensure spin-up on stiff bearings (optional)
  M106 S255
  G4 P300
  M106 S166  # ~65%

