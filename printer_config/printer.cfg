

[gcode_macro HOME_POS]
description: Move all joints to a defined home pose (coordinated shoulder pair).
gcode:
  RESPOND MSG="üè† Moving to HOME_POS"
  # Enable required joints
  MANUAL_STEPPER STEPPER=joint1 ENABLE=1
  MANUAL_STEPPER STEPPER=joint2 ENABLE=1
  MANUAL_STEPPER STEPPER=joint2b ENABLE=1
  MANUAL_STEPPER STEPPER=joint3 ENABLE=1
  MANUAL_STEPPER STEPPER=joint4 ENABLE=1
  MANUAL_STEPPER STEPPER=joint5 ENABLE=1

  # Coordinated moves (shoulder pair in sync)
  MANUAL_STEPPER STEPPER=joint1 MOVE=0   SPEED=30 SYNC=0
  MANUAL_STEPPER STEPPER=joint3 MOVE=110 SPEED=20 SYNC=0
  MANUAL_STEPPER STEPPER=joint4 MOVE=-90 SPEED=30 SYNC=0
  MANUAL_STEPPER STEPPER=joint5 MOVE=90  SPEED=30 SYNC=0
  MANUAL_STEPPER STEPPER=joint2 MOVE=-105 SPEED=20 SYNC=0
  MANUAL_STEPPER STEPPER=joint2b MOVE=-105 SPEED=20 SYNC=1
  RESPOND MSG="‚úÖ HOME_POS reached"
# ============================================================================
# üö® SAFETY REQUIREMENTS:
# ============================================================================
# ============================================================================
# üö® SAFETY REQUIREMENTS:
# ============================================================================
# 
# 1. JOINT 2 SYNCHRONIZATION: Motors joint2 (Motor-8) and joint2b (Motor-7)
#    are mechanically coupled. NEVER move independently!
#    ‚úÖ Manual: MANUAL_STEPPER with SYNC parameters
#    ‚ùå NEVER: Individual motor commands without coordination
#
# 2. Commands
    #MANUAL_STEPPER STEPPER=joint1 MOVE=0 SPEED=30 SYNC=0
    #MANUAL_STEPPER STEPPER=joint3 MOVE=0 SPEED=0 SYNC=0
    #MANUAL_STEPPER STEPPER=joint4 MOVE=0 SPEED=60 SYNC=0
    #MANUAL_STEPPER STEPPER=joint5 MOVE=0 SPEED=60 SYNC=0
    #MANUAL_STEPPER STEPPER=joint2 MOVE=-20 SPEED=30 SYNC=0
    #MANUAL_STEPPER STEPPER=joint2b MOVE=-20 SPEED=30 SYNC=1


    #MANUAL_STEPPER STEPPER=joint1 SET_POSITION=0 SYNC=0
    #MANUAL_STEPPER STEPPER=joint3 SET_POSITION=0 SYNC=0
    #MANUAL_STEPPER STEPPER=joint4 SET_POSITION=0 SYNC=0
    #MANUAL_STEPPER STEPPER=joint5 SET_POSITION=0 SYNC=0
    #MANUAL_STEPPER STEPPER=joint6 SET_POSITION=0 SYNC=0
    #MANUAL_STEPPER STEPPER=joint7 SET_POSITION=300 SYNC=0
    #MANUAL_STEPPER STEPPER=joint2 SET_POSITION=0 SYNC=0
    #MANUAL_STEPPER STEPPER=joint2b SET_POSITION=0 SYNC=1

    #MANUAL_STEPPER STEPPER=joint1 MOVE=0 SPEED=30 SYNC=0
    #MANUAL_STEPPER STEPPER=joint3 MOVE=110 SPEED=20 SYNC=0
    #MANUAL_STEPPER STEPPER=joint4 MOVE=-0 SPEED=30 SYNC=0
    #MANUAL_STEPPER STEPPER=joint5 MOVE=0 SPEED=30 SYNC=0
    #MANUAL_STEPPER STEPPER=joint2 MOVE=-105 SPEED=20 SYNC=0
    #MANUAL_STEPPER STEPPER=joint2b MOVE=-105 SPEED=20 SYNC=1

#
# ============================================================================
# üìã CONFIGURATION REFERENCE FOR OTHER SYSTEMS:
# ============================================================================
#
# ROS Integration:    Reference position_min/max for joint_limits.yaml
# MoveIt Planning:    Use these ranges for planning scene setup
# API Interfaces:     Enforce these limits in trajectory validation
# Documentation:      Always cite this file as authoritative source
# Testing Scripts:    Respect these limits in automated movement tests
#
# Last Updated: $(date '+%Y-%m-%d %H:%M:%S') - Joint range documentation added
# Hardware: BTT Octopus Max EZ + TMC5160 drivers
# Firmware: Klipper (manual_stepper configuration)
#
# ============================================================================

# RESPOND command support
[respond]
default_type: echo


# This file contains common pin mappings for the BIGTREETECH Octopus Max EZ.
# To use this config, the firmware should be compiled for the STM32H723 with a "128KiB bootloader" and "25 MHz crystal",
# and one of:
# Communication interface: "USB (on PA11/PA12)",
# Communication interface: "CAN bus (on PD0/PD1)", or
# Communication interface: "USB to CAN bus bridge (USB on PA11/PA12))" and CAN bus interface: "CAN bus (on PD0/PD1)".
# See docs/Config_Reference.md for a description of parameters.

# BCN3D Moveo 6-DOF Robotic Arm Configuration
# Inverted joint order as requested

# Motor-1 Slot - Linear Traverse (Joint 7) - ENABLED
# Mechanics: 23HS30-2804A, 25:1 gearbox (NMRV30), Mod 3 rack, 16T pinion, herringbone; microstep = 1
[manual_stepper joint7]
step_pin: PC13
dir_pin: PC14
enable_pin: !PE6
microsteps: 1
full_steps_per_rotation: 200
# rotation_distance = pi * module * teeth / gear_ratio = pi*3*16/25 ‚âà 6.03186 mm per motor rev
rotation_distance: 6.03186
# Initial safe motion limits (mm, mm/s); refine after bring-up
velocity: 5
accel: 50
# No endstops for now

# TMC5160 Driver for Joint7 (Motor-1 slot)
[tmc5160 manual_stepper joint7]
cs_pin: PG14 
spi_bus: spi4
run_current: 2.6            # conservative start for 2.8A rated motor
hold_current: 2.0
sense_resistor: 0.075
stealthchop_threshold: 999999   # per request
interpolate: True

# Motor-6 - Tool Head (Joint 6) - ENABLED
[manual_stepper joint6]
step_pin: PG15
dir_pin: PB3
enable_pin: !PD5
microsteps: 1
full_steps_per_rotation: 200
rotation_distance: 360
gear_ratio: 19:1
velocity: 500
accel: 120
endstop_pin: ^!PC15  # M6-DET (motor6 endstop)
#position_min: -90
#position_max: 90

# TMC5160 Driver for Joint6 (Motor-6)
[tmc5160 manual_stepper joint6]
cs_pin: PG9                 # Motor-6 CS/UART on Octopus Max EZ
spi_bus: spi4
run_current: 0.42            # 70% of 0.6A max
hold_current: 0.30           # 50% of 0.6A max
sense_resistor: 0.075
stealthchop_threshold: 999999
interpolate: True

# Motor-5 - Wrist Roll (Joint 5) - ENABLED
[manual_stepper joint5]
step_pin: PB5
dir_pin: PB4
enable_pin: !PB6
microsteps: 1
full_steps_per_rotation: 200
rotation_distance: 360
gear_ratio: 45:2  #5:1 gearbox with 45:10 T5 pulley reduction)
velocity: 500
accel: 120
#position_endstop: 80 
endstop_pin: ^!PF1  # M5-DET (motor5 endstop)
position_min: -90
position_max: 85

# TMC5160 Driver for Joint5 (Motor-5)
[tmc5160 manual_stepper joint5]
cs_pin: PG10                # Motor-5 CS/UART on Octopus Max EZ
spi_bus: spi4
run_current: 0.35            # 70% of 0.5A max
hold_current: 0.25           # 50% of 0.5A max
sense_resistor: 0.075
stealthchop_threshold: 999999
interpolate: True

# Motor-4 - Wrist Pitch (Joint 4) - ENABLED
[manual_stepper joint4]
step_pin: PB8
dir_pin: PB9
enable_pin: !PB7
microsteps: 1
full_steps_per_rotation: 200
rotation_distance: 360
gear_ratio: 5.16:1
velocity: 500
accel: 100
endstop_pin: ^!PF3  # M4-DET (motor4 endstop)
position_min: -180
position_max: 180

# TMC5160 Driver for Joint4 (Motor-4)
[tmc5160 manual_stepper joint4]
cs_pin: PG11                # Motor-4 CS/UART on Octopus Max EZ
spi_bus: spi4
run_current: 0.28            # 70% of 0.4A max
hold_current: 0.2           # 50% of 0.4A max
sense_resistor: 0.075
stealthchop_threshold: 999999
interpolate: True

# Motor-3 - Elbow (Joint 3) - ENABLED  (SPEED=30)
[manual_stepper joint3]
step_pin: PE1
dir_pin: !PE0
enable_pin: !PE2
microsteps: 1
full_steps_per_rotation: 200
rotation_distance: 360          # Use degree units for consistency
gear_ratio: 600:7  # 20:1 * 60:14 = 600:7 (~85.714:1)
endstop_pin: ^!PF4             # Endstop3 (mapped to PF3) ‚Äî adjust if your wiring uses a different port
position_endstop: 115           # Assume positive endstop; adjust after calibration
position_min: -90              # Soft limits (assumed initial range)
position_max: 115
velocity: 5
accel: 80
homing_speed: 10
second_homing_speed: 3
homing_retract_dist: 5

# TMC5160 Driver for Joint3 (Motor-3)
# Model: 17HS19-1684S-PG14 (max 1.68A)
[tmc5160 manual_stepper joint3]
cs_pin: PG12                 # Candidate CS pin for Motor-6 (adjusted)
spi_bus: spi4
run_current: 1.20       # 70%
hold_current: 0.85       # 50% 
sense_resistor: 0.075
stealthchop_threshold: 999999
interpolate: True

# =================================================================
# JOINT 2 SHOULDER - DUAL MOTOR CONFIGURATION
# =================================================================
# ‚ö†Ô∏è  CRITICAL SAFETY REQUIREMENT:
# Joint2 uses TWO mechanically linked motors that MUST move in sync
# - joint2  (Motor-8): Primary motor with endstop
# - joint2b (Motor-7): Secondary motor with inverted direction
# 
# ‚ùå NEVER move these motors independently
# ‚úÖ ALWAYS use coordinated movement commands (SYNC parameters)
# ‚úÖ Use JOINT2_MOVE, JOINT2_PLUS, JOINT2_MINUS macros
# =================================================================

# Motor-7 - Joint 2B (Secondary motor)
# Direction inverted for coordinated dual-motor movement

# TMC5160 Driver for Joint2b (Motor-7)- CORRECTED CONFIGURATION
[tmc5160 manual_stepper joint2b]
cs_pin: PD7
spi_bus: spi4
run_current: 2.8                # 70% of 4.0A motor rating for stronger movement torque
hold_current: 2.0               # 50% of motor rating for holding torque
sense_resistor: 0.075
stealthchop_threshold: 999999   # Enable StealthChop for quiet operation
interpolate: True

[manual_stepper joint2b]
# CRITICAL: joint2 and joint2b MUST move in sync at all times
# These motors are mechanically linked - never move independently
step_pin: PD3
dir_pin: PD2  # Invert direction so joint2b matches mechanical coupling with joint2
enable_pin: !PD4
# NO endstop_pin - joint2b follows joint2 for homing
microsteps: 1
full_steps_per_rotation: 200
rotation_distance: 360          # One motor rev = 360 "deg units"
gear_ratio: 77:14               # Motor:joint ratio (Joint 2 calibrated ratio)
position_min: -110               # Lower soft limit (matches joint2)
position_max: 120.0               # Upper soft limit (matches HOME_JOINT2 approach range)
velocity: 500
accel: 60
# Note: No homing parameters - joint2b follows joint2 for homing

# Motor-8 - Joint 2 Main (Dual-motor setup with Motor-7)
# Works with joint2b for coordinated shoulder movement

# TMC5160 Driver for Joint2 (Motor-8) - CORRECTED CONFIGURATION
[tmc5160 manual_stepper joint2]
cs_pin: PD6
spi_bus: spi4
run_current: 2.8                # 70% of 4.0A motor rating for stronger movement torque
hold_current: 2.0               # 50% of motor rating for holding torque
sense_resistor: 0.075
stealthchop_threshold: 999999   # Enable StealthChop for quiet operation
interpolate: True

[manual_stepper joint2]
# DUAL-MOTOR SHOULDER JOINT - Primary motor (Motor-8)
# ALWAYS coordinate with joint2b - never move independently
step_pin: PA10
dir_pin: !PA9
enable_pin: !PA15
endstop_pin: ^!PF2
microsteps: 1
full_steps_per_rotation: 200
rotation_distance: 360          # One motor rev = 360 "deg units"
gear_ratio: 77:14               # Motor:joint ratio (Joint 2 calibrated ratio)
position_endstop: 115.3        # Upper limit endstop trigger (now positive)
position_min: -110               # Lower soft limit
position_max: 120.0               # Upper soft limit (matches HOME_JOINT2 approach range)
velocity: 500
accel: 60
homing_speed: 10                # deg/s first pass
second_homing_speed: 3          # deg/s precise approach  
homing_retract_dist: 5          # deg backoff distance

# Motor-1 / Base Rotation (Joint 1) - Back to manual_stepper
[tmc5160 manual_stepper joint1]
cs_pin: PG13
spi_bus: spi4
run_current: 0.5                # 80% of 0.63A motor rating for safe operation
hold_current: 0.38               # 60% of motor rating for holding torque   
sense_resistor: 0.075
stealthchop_threshold: 999999
interpolate: True

[manual_stepper joint1]
step_pin: PE4
dir_pin: PE5
enable_pin: !PE3
microsteps: 1
full_steps_per_rotation: 200
rotation_distance: 360          # One motor rev = 360 "deg units"
gear_ratio: 100:10               # Updated calibration: motor:joint (10 motor revs = 1 joint rev)
endstop_pin: ^!PF0              # Assuming NO switch, trigger on logic high (maintains prior invert)
position_endstop: 82             # Physical trigger angle
position_min: -82               # Full range negative soft limit
position_max: 82                # Positive soft limit
velocity: 500
accel: 80
homing_speed: 10                # deg/s first pass
second_homing_speed: 3          # deg/s precise approach  
homing_retract_dist: 5          # deg backoff distance

# Simple fan for cooling electronics
[fan]
pin: PA6

# 3-wire fan tachometer input - PC3 pin 29
# Using filament sensor to detect tachometer pulses (standard method)
[filament_switch_sensor fan4_tach]
switch_pin: ^PC3  # Pin 29 - Fan4 tachometer with pullup resistor
pause_on_runout: False
runout_gcode:
insert_gcode:

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_1B0026000651323235363233-if00

[printer]
kinematics: none
max_velocity: 500
max_accel: 500

[board_pins]
aliases:
    # FPC header, Aliases EXP1 & EXP2 for mini12864
    EXP1_1=PG2, EXP1_2=PD15,
    EXP1_3=PD14, EXP1_4=PD13,
    EXP1_5=PD12, EXP1_6=PD11,
    EXP1_7=PD10, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PE13, EXP2_2=PE12,
    EXP2_3=PG5, EXP2_4=PE11,
    EXP2_5=PG4, EXP2_6=PE14,
    EXP2_7=PG3, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<NC>

# Virtual SD Card Support
[virtual_sdcard]
path: ~/printer_data/gcodes

# Pause/Resume Support
[pause_resume]

# Display Status Support (for Mainsail/Fluidd)
[display_status]

# Enable object cancellation
[exclude_object]

# Mainsail klipper definitions
[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
gcode:
  PAUSE_BASE
  
[gcode_macro HOME_JOINT4]
description: Home Joint 4 (wrist pitch) - basic approach/backoff with START_POS preset
gcode:
  {% set speed = params.SPEED|default(20)|float %}
  {% set approach = params.APPROACH|default(180)|float %}
  {% set backoff = params.BACKOFF|default(0)|float %}
  {% set backoff_speed = params.BACKOFF_SPEED|default(20)|float %}
  {% set start_pos = params.START_POS|default(-180)|float %}

  RESPOND MSG="üè† === HOMING JOINT4 (basic) ==="
  RESPOND MSG="Approach {approach}¬∞ @ {speed}deg/s; backoff {backoff}¬∞ @ {backoff_speed}deg/s"
  MANUAL_STEPPER STEPPER=joint4 ENABLE=1

  # Preset logical position
  MANUAL_STEPPER STEPPER=joint4 SET_POSITION={start_pos}
  RESPOND MSG="Preset logical position to {start_pos|round(2)}¬∞ (override with START_POS)"

  # Single approach move until endstop triggers
  MANUAL_STEPPER STEPPER=joint4 MOVE={approach} SPEED={speed} STOP_ON_ENDSTOP=1
  RESPOND MSG="üîî Endstop triggered."
  MANUAL_STEPPER STEPPER=joint4 SET_POSITION=179
  # Back off and set logical position to backoff distance from endstop
  MANUAL_STEPPER STEPPER=joint4 MOVE=0 SPEED={backoff_speed}
  MANUAL_STEPPER STEPPER=joint4 SET_POSITION=0
  RESPOND MSG="‚úÖ Joint4 homed: logical position set to {backoff}¬∞ from endstop."




# === Automatic Fan Startup (Option 1 Always-On) ===
# Brings FAN0 (default [fan]) to ~65% (M106 S166) shortly after Klipper starts.
# Adjust S value (0-255) or replace with SET_FAN_SPEED if converting to fan_generic.
[delayed_gcode FAN_BOOT]
initial_duration: 2
gcode:
  # Kick to full briefly to ensure spin-up on stiff bearings (optional)
  M106 S255
  G4 P300
  M106 S166  # ~65%

[gcode_macro ENABLE_ALL_MOTORS]
description: Enable all configured manual steppers (arm + shoulder pair)
gcode:
  RESPOND MSG="üîß Enabling all motors (joint1..joint6 + joint2 + joint2b)"
  MANUAL_STEPPER STEPPER=joint1 ENABLE=1
  MANUAL_STEPPER STEPPER=joint2 ENABLE=1
  MANUAL_STEPPER STEPPER=joint2b ENABLE=1
  MANUAL_STEPPER STEPPER=joint3 ENABLE=1
  MANUAL_STEPPER STEPPER=joint4 ENABLE=1
  MANUAL_STEPPER STEPPER=joint5 ENABLE=1
  MANUAL_STEPPER STEPPER=joint6 ENABLE=1
  RESPOND MSG="‚úÖ All motors enabled"

[gcode_macro HOME_JOINT5]
description: Home Joint 5 (wrist roll) using endstop - reliable approach/backoff
gcode:
  {% set speed = params.SPEED|default(20)|float %}
  {% set approach = params.APPROACH|default(85)|float %}
  {% set backoff = params.BACKOFF|default(0)|float %}
  {% set backoff_speed = params.BACKOFF_SPEED|default(20)|float %}
  {% set start_pos = params.START_POS|default(-90)|float %}

  RESPOND MSG="üè† === HOMING JOINT5 (basic) ==="
  RESPOND MSG="Approach {approach}¬∞ @ {speed}deg/s; backoff {backoff}¬∞ @ {backoff_speed}deg/s"
  MANUAL_STEPPER STEPPER=joint5 ENABLE=1

  # Preset logical position
  MANUAL_STEPPER STEPPER=joint5 SET_POSITION={start_pos}
  RESPOND MSG="Preset logical position to {start_pos|round(2)}¬∞ (override with START_POS)"

  # Single approach move until endstop triggers
  MANUAL_STEPPER STEPPER=joint5 MOVE={approach} SPEED={speed} STOP_ON_ENDSTOP=1
  RESPOND MSG="üîî Endstop triggered."

  # Back off and set logical position to backoff distance from endstop
  MANUAL_STEPPER STEPPER=joint5 MOVE={backoff} SPEED={backoff_speed}
  MANUAL_STEPPER STEPPER=joint5 SET_POSITION={backoff}
  RESPOND MSG="‚úÖ Joint5 homed: logical position set to {backoff}¬∞ from endstop."


[gcode_macro HOME_JOINT1]
description: Home Joint 1 (base rotation) - basic approach/backoff with START_POS preset
gcode:
  {% set speed = params.SPEED|default(20)|float %}
  {% set approach = params.APPROACH|default(82)|float %}
  {% set backoff = params.BACKOFF|default(0)|float %}
  {% set backoff_speed = params.BACKOFF_SPEED|default(20)|float %}
  {% set start_pos = params.START_POS|default(-80)|float %}

  RESPOND MSG="üè† === HOMING JOINT1 (basic) ==="
  RESPOND MSG="Approach {approach}¬∞ @ {speed}deg/s; backoff {backoff}¬∞ @ {backoff_speed}deg/s"
  MANUAL_STEPPER STEPPER=joint1 ENABLE=1

  # Preset logical position
  MANUAL_STEPPER STEPPER=joint1 SET_POSITION={start_pos}
  RESPOND MSG="Preset logical position to {start_pos|round(2)}¬∞ (override with START_POS)"

  # Single approach move until endstop triggers
  MANUAL_STEPPER STEPPER=joint1 MOVE={approach} SPEED={speed} STOP_ON_ENDSTOP=1
  RESPOND MSG="üîî Endstop triggered."

  # Back off and set logical position to backoff distance from endstop
  MANUAL_STEPPER STEPPER=joint1 MOVE={backoff} SPEED={backoff_speed}
  MANUAL_STEPPER STEPPER=joint1 SET_POSITION={backoff}
  RESPOND MSG="‚úÖ Joint1 homed: logical position set to {backoff}¬∞ from endstop."


[gcode_macro HOME]
description: Final homing sequence: (1) Simul home J3/J4/J5 with synchronized backoffs, (2) HOME_JOINT2, (3) HOME_JOINT1, (4) move to final stance
gcode:
  # Hard-coded homing for J3/J4/J5
  # Final stance is hard-coded

  RESPOND MSG="üè† === HOME: Simul homing J3/J4/J5, then J2, then J1; finish with stance ==="

  # Enable and preset logical positions for J3/J4/J5
  MANUAL_STEPPER STEPPER=joint3 ENABLE=1
  MANUAL_STEPPER STEPPER=joint4 ENABLE=1
  MANUAL_STEPPER STEPPER=joint5 ENABLE=1
  MANUAL_STEPPER STEPPER=joint3 SET_POSITION=-90
  MANUAL_STEPPER STEPPER=joint4 SET_POSITION=-180
  MANUAL_STEPPER STEPPER=joint5 SET_POSITION=-90
  RESPOND MSG="J3 start=-90¬∞, J4 start=-180¬∞, J5 start=-90¬∞"

  # Approach endstops simultaneously
  MANUAL_STEPPER STEPPER=joint3 MOVE=115 SPEED=10 STOP_ON_ENDSTOP=1 SYNC=0
  MANUAL_STEPPER STEPPER=joint4 MOVE=180 SPEED=20 STOP_ON_ENDSTOP=1 SYNC=0
  MANUAL_STEPPER STEPPER=joint5 MOVE=85 SPEED=20 STOP_ON_ENDSTOP=1 SYNC=0
  # Wait for all approaches
  MANUAL_STEPPER STEPPER=joint3 SYNC=1
  MANUAL_STEPPER STEPPER=joint4 SYNC=1
  MANUAL_STEPPER STEPPER=joint5 SYNC=1
  RESPOND MSG="üîî J3/J4/J5 endstops reached"

  # Synchronized backoffs and zeroing (set logical to 0)
  MANUAL_STEPPER STEPPER=joint3 MOVE=100 SPEED=20 SYNC=0
  MANUAL_STEPPER STEPPER=joint4 MOVE=0 SPEED=30 SYNC=0
  MANUAL_STEPPER STEPPER=joint5 MOVE=0 SPEED=30 SYNC=0
  MANUAL_STEPPER STEPPER=joint3 SYNC=1
  MANUAL_STEPPER STEPPER=joint4 SYNC=1
  MANUAL_STEPPER STEPPER=joint5 SYNC=1
  MANUAL_STEPPER STEPPER=joint3 SET_POSITION=100
  MANUAL_STEPPER STEPPER=joint4 SET_POSITION=0
  MANUAL_STEPPER STEPPER=joint5 SET_POSITION=0
  RESPOND MSG="‚úÖ J3/J4/J5 homed and zeroed"

  # Shoulder homing (dual motor macro)
  RESPOND MSG="‚û° HOME_JOINT2"
  HOME_JOINT2

  # Base homing
  RESPOND MSG="‚û° HOME_JOINT1"
  HOME_JOINT1

  # Final stance: joint2/2b=-50, joint3=110, others=0
  RESPOND MSG="üéØ Moving to final stance"
  MANUAL_STEPPER STEPPER=joint2 ENABLE=1
  MANUAL_STEPPER STEPPER=joint2b ENABLE=1
  MANUAL_STEPPER STEPPER=joint3 ENABLE=1
  MANUAL_STEPPER STEPPER=joint4 ENABLE=1
  MANUAL_STEPPER STEPPER=joint5 ENABLE=1
  MANUAL_STEPPER STEPPER=joint6 ENABLE=1
  MANUAL_STEPPER STEPPER=joint7 ENABLE=1
  # Shoulder pair together
  MANUAL_STEPPER STEPPER=joint2 MOVE=-103 SPEED=20 SYNC=0
  MANUAL_STEPPER STEPPER=joint2b MOVE=-103 SPEED=20 SYNC=0
  # Elbow to 110
  MANUAL_STEPPER STEPPER=joint3 MOVE=110 SPEED=20 SYNC=0
  # Others to 0
  MANUAL_STEPPER STEPPER=joint4 MOVE=90 SPEED=20 SYNC=0
  MANUAL_STEPPER STEPPER=joint5 MOVE=0 SPEED=20 SYNC=0
  MANUAL_STEPPER STEPPER=joint6 MOVE=0 SPEED=20 SYNC=0
  MANUAL_STEPPER STEPPER=joint7 MOVE=0 SPEED=20 SYNC=0
  RESPOND MSG="‚úÖ HOME complete; stance set (J2/J2b=-50¬∞, J3=110¬∞, others=0¬∞)"


[gcode_macro HOME_JOINT2]
description: Home Joint 2 (shoulder, dual-motor) - basic approach/backoff with START_POS preset
gcode:
  {% set speed = params.SPEED|default(10)|float %}
  {% set approach = params.APPROACH|default(120)|float %}
  {% set backoff = params.BACKOFF|default(-10)|float %}
  {% set backoff_speed = params.BACKOFF_SPEED|default(20)|float %}
  {% set start_pos = params.START_POS|default(-110)|float %}

  RESPOND MSG="üè† === HOMING JOINT2 (basic) ==="
  RESPOND MSG="Approach {approach}¬∞ @ {speed}deg/s; backoff {backoff}¬∞ @ {backoff_speed}deg/s"


  MANUAL_STEPPER STEPPER=joint3 MOVE=-90 SPEED=20 SYNC=0
  MANUAL_STEPPER STEPPER=joint2 MOVE=100 SPEED=20 SYNC=0
  MANUAL_STEPPER STEPPER=joint2b MOVE=100 SPEED=20 SYNC=0


  # Primary enabled; follower disabled during approach to avoid fighting
  MANUAL_STEPPER STEPPER=joint2 ENABLE=1
  MANUAL_STEPPER STEPPER=joint2b ENABLE=0

  # Preset logical position for both
  MANUAL_STEPPER STEPPER=joint2 SET_POSITION={start_pos}
  MANUAL_STEPPER STEPPER=joint2b SET_POSITION={start_pos}
  RESPOND MSG="Preset logical position to {start_pos|round(2)}¬∞ for both (override with START_POS)"

  # Approach endstop (primary only; follower disabled)
  MANUAL_STEPPER STEPPER=joint2 MOVE={approach} SPEED={speed} STOP_ON_ENDSTOP=1
 
  RESPOND MSG="üîî Joint2 endstop triggered. Re-enabling follower for synchronized backoff."

  #perform a synchronized backoff on both motors
  # Re-enable follower and back off both together in the same physical direction
  MANUAL_STEPPER STEPPER=joint2 SET_POSITION=111
  MANUAL_STEPPER STEPPER=joint2b SET_POSITION=111
  #MANUAL_STEPPER STEPPER=joint2b ENABLE=1
  MANUAL_STEPPER STEPPER=joint3 MOVE=0 SPEED=10 SYNC=0
  MANUAL_STEPPER STEPPER=joint2 MOVE=0 SPEED=10 SYNC=0
  MANUAL_STEPPER STEPPER=joint2b MOVE=0 SPEED=10 SYNC=1
  # Set logical positions for both motors to the backoff value
  MANUAL_STEPPER STEPPER=joint2 SET_POSITION=0
  MANUAL_STEPPER STEPPER=joint2b SET_POSITION=0
  RESPOND MSG="‚úÖ Joint2 homed: logical position set to {backoff}¬∞ from endstop (both motors)."


[gcode_macro HOME_JOINT3]
description: Home Joint 3 (elbow) - basic approach/backoff with START_POS preset
gcode:
  {% set speed = params.SPEED|default(20)|float %}
  {% set approach = params.APPROACH|default(115)|float %}
  {% set backoff = params.BACKOFF|default(100)|float %}
  {% set backoff_speed = params.BACKOFF_SPEED|default(20)|float %}
  {% set start_pos = params.START_POS|default(-90)|float %}

  RESPOND MSG="üè† === HOMING JOINT3 (basic) ==="
  RESPOND MSG="Approach {approach}¬∞ @ {speed}deg/s; backoff {backoff}¬∞ @ {backoff_speed}deg/s"
  MANUAL_STEPPER STEPPER=joint3 ENABLE=1

  # Preset logical position
  MANUAL_STEPPER STEPPER=joint3 SET_POSITION={start_pos}
  RESPOND MSG="Preset logical position to {start_pos|round(2)}¬∞ (override with START_POS)"

  # Single approach move until endstop triggers
  MANUAL_STEPPER STEPPER=joint3 MOVE={approach} SPEED={speed} STOP_ON_ENDSTOP=1
  RESPOND MSG="üîî Endstop triggered."

  # Back off and set logical position to backoff distance from endstop
  MANUAL_STEPPER STEPPER=joint3 MOVE={backoff} SPEED={backoff_speed}
  MANUAL_STEPPER STEPPER=joint3 SET_POSITION={backoff}
  RESPOND MSG="‚úÖ Joint3 homed: logical position set to {backoff}¬∞ from endstop."



